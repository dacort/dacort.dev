<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Big Data Stack with CDK | Damon Cortesi</title><meta name=keywords content="aws,emr,cdk,aws-cdk,python"><meta name=description content="How I built my own Apache Spark environment on AWS using Amazon EMR, Amazon EKS, and the AWS Cloud Development Kit (CDK)."><meta name=author content><link rel=canonical href=https://dacort.dev/posts/cdk-big-data-stack/><link crossorigin=anonymous href=/assets/css/stylesheet.min.640768aec184f5d7657b498b44c1649aeeac390be208b1077640933543054b77.css integrity="sha256-ZAdorsGE9ddle0mLRMFkmu6sOQviCLEHdkCTNUMFS3c=" rel="preload stylesheet" as=style><link rel=preload href=/images/dacort.jpeg as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://dacort.dev/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dacort.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dacort.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://dacort.dev/apple-touch-icon.png><link rel=mask-icon href=https://dacort.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><meta property="og:title" content="Big Data Stack with CDK"><meta property="og:description" content="How I built my own Apache Spark environment on AWS using Amazon EMR, Amazon EKS, and the AWS Cloud Development Kit (CDK)."><meta property="og:type" content="article"><meta property="og:url" content="https://dacort.dev/posts/cdk-big-data-stack/"><meta property="og:image" content="https://dacort.dev/images/cdk-big-data-stack-cover.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-18T21:59:00-07:00"><meta property="article:modified_time" content="2021-06-18T21:59:00-07:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dacort.dev/images/cdk-big-data-stack-cover.jpg"><meta name=twitter:title content="Big Data Stack with CDK"><meta name=twitter:description content="How I built my own Apache Spark environment on AWS using Amazon EMR, Amazon EKS, and the AWS Cloud Development Kit (CDK)."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dacort.dev/posts/"},{"@type":"ListItem","position":2,"name":"Big Data Stack with CDK","item":"https://dacort.dev/posts/cdk-big-data-stack/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Big Data Stack with CDK","name":"Big Data Stack with CDK","description":"How I built my own Apache Spark environment on AWS using Amazon EMR, Amazon EKS, and the AWS Cloud Development Kit (CDK).","keywords":["aws","emr","cdk","aws-cdk","python"],"articleBody":"I wanted to write a post about how I built my own Apache Spark environment on AWS using Amazon EMR, Amazon EKS, and the AWS Cloud Development Kit (CDK). This stack also creates an EMR Studio environment that can be used to build and deploy data notebooks.\nDisclaimer: I work for AWS on the EMR team and built this stack for my various demos and it is not intended for production use-cases. üôè\nAlso note that the commands below are for demonstration purposes only, the full code is available in my demo-code/cdk/big-data-stack repository.\nOverview At re:Invent 2020, AWS introduced EMR on EKS - a way to run Apache Spark workloads on Kubernetes using managed services. Once you‚Äôre up and running, you can submit a Spark job to EMR on EKS with a single AWS CLI command. But provisioning EKS, ensuring it has all the necessary resources to run your jobs, creating IAM roles and Kubernetes service accounts, and linking those back to EMR can be a lot of manual effort. Using AWS CDK, we can easily provision the entire stack:\n A VPC in 3 availability zones An EKS cluster with the following addons  Cluster Autoscaler Kubernetes Dashboard   An EMR virtual cluster connected to our EKS cluster An EMR Studio environment  A Service Catalog cluster template    This is the high-level architecture of what the resulting stack will look like. Now let‚Äôs walk through each different piece.\nVPC This is probably the easiest part of the whole setup. In CDK, you can provision a VPC with the following code:\nfrom aws_cdk import aws_ec2 as ec2 ec2.Vpc(self, \"EMRDemos\", max_azs=3) And you‚Äôre done. üéâ In my stack, I make the resulting ec2.Vpc object an attribute on the VPC stack so I can use it in other parts of my stack.\napp = cdk.App() vpc = VPCStack(app, \"VPCStack\") eks = EKSStack(app, \"EKSStack\", vpc.vpc) emr_containers = EMRContainersStack(app, \"EMRContainers\", vpc.vpc, eks.cluster) emr_studio = EMRStudio(app, \"EMRStudio\", vpc.vpc, \"big-data-studio\") app.synth() Let‚Äôs walk through what happens in each of these stacks.\nEKSStack This one is a little more complex. In many cases, you only need to stand up your EKS cluster once and you‚Äôll use that in perpetuity. But there certainly are cases where you might provision multiple EKS stacks for security or organizational reasons. Provisioning an EKS stack in CDK is relatively straightforward.\n First, provision the EKS Cluster  from aws_cdk import ( aws_eks as eks, aws_ec2 as ec2, aws_iam as iam, ) cluster = eks.Cluster( self, \"EksForSpark\", cluster_name=\"data-team\", version=eks.KubernetesVersion.V1_19, default_capacity=0, endpoint_access=eks.EndpointAccess.PUBLIC_AND_PRIVATE, vpc=vpc, vpc_subnets=[ec2.SubnetSelection(subnet_type=ec2.SubnetType.PRIVATE)], )  Then, add one or more managed node groups.  nodegroup = cluster.add_nodegroup_capacity( \"base-node-group\", instance_types=[ec2.InstanceType(\"m5.xlarge\")], # You could add additional instance types here min_size=1, # The node group can scale to 1 max_size=20, # And up to 20 nodes disk_size=50, # Give each node 50gb of disk )  You‚Äôll also likely want to grant an IAM role admin access to the cluster  admin_iam_role_name = \"Admin\" # This role must already exist in your AWS account account_id = cdk.Aws.ACCOUNT_ID admin_role = iam.Role.from_role_arn( self, \"admin_role\", f\"arn:aws:iam::{account_id}:role/{admin_role_name}\" ) cluster.aws_auth.add_masters_role(admin_role) Cluster Autoscaler Finally, a critical component to install is the Cluster Autoscaler. The EKS documentation shows how to deploy it using the kubectl command, but I wanted to wrap this up in the CDK stack. I also ran into this issue where a Helm chart for 1.19 doesn‚Äôt exist. üôÅ.\nSo I created an autoscaler module that I can easily apply to my cluster and node groups.\ncluster_name = \"data-team\" ClusterAutoscaler( cluster_name, self, cluster, [nodegroup] ).enable_autoscaling() This code performs the following steps in order to enable the cluster autoscaler on an EKS cluster:\n Adds tags to the passed node groups to enable auto discovery Creates a new IAM Role that can change Auto Scaling Groups Creates a Kubernetes service account Creates a new cluster-autoscaler deployment Creates the corresponding rbac rules  Kubernetes Dashboard The Kubernetes Dashboard is also extremely valuable to be able to examine what‚Äôs happening in your EKS cluster. It‚Äôs easy to install by using the CDK add_helm_chart functionality.\nchart = cluster.add_helm_chart( \"kubernetes-dashboard\", namespace=\"kubernetes-dashboard\", chart=\"kubernetes-dashboard\", repository=\"https://kubernetes.github.io/dashboard/\", values={ \"fullnameOverride\": \"kubernetes-dashboard\", # This must be set to acccess the UI via `kubectl proxy` \"extraArgs\": [\"--token-ttl=0\"], # This prevents your access token from expiring, but is not intended for a production environment }, ) üíÅ Note that I‚Äôm setting --token-ttl=0 so I don‚Äôt have to re-sign in to the Dashboard every 10(!) minutes, but you shouldn‚Äôt use this in a production environment. There‚Äôs some more info about adjusting the timeout the dashboard here.\nEMRContainersStack A pre-requisite to running EMR on EKS is that you have to map the AWSServiceRoleForAmazonEMRContainers role to the EKS cluster. In order to prevent a circular dependency, I ended up doing this in the EKS stack.\nservice_role_name = f\"arn:aws:iam::{cdk.Aws.ACCOUNT_ID}:role/AWSServiceRoleForAmazonEMRContainers\" emrsvcrole = iam.Role.from_role_arn( self, \"EmrSvcRole\", service_role_name, mutable=False ) cluster.aws_auth.add_role_mapping( emrsvcrole, groups=[], username=\"emr-containers\" ) Setting up EMR on EKS requires several steps:\n Create a namespace for EMR to use Create a k8s cluster role for EMR Bind the cluster role to the emr-containers user we created above Create a (nicely-named) job execution role And then create our EMR virtual cluster  If you want to use EMR Studio with EMR on EKS, you can also (optionally) create a managed endpoint. I don‚Äôt quite have this fully automated with CDK yet.\nI won‚Äôt detail the whole setup here because it‚Äôs about 400 lines of Python code, but you can see my EMR on EKS Stack on GitHub.\n‚ö†Ô∏è One thing to call out is that inside the create_job_execution_role method, we create a new job role we can use to run our jobs on EMR on EKS. This role is, admittedly, way overscoped and allows full access to S3, EC2, Glue, and CloudWatch. It is heavily recommended that you scope down the permissions this role has.\nEMRStudio Setting up EMR Studio requires the creation of several Studio-specific IAM roles, an S3 bucket for Studio assets, and mapping an AWS SSO user to the Studio.\nThe EMRStudio stack performs all these steps as well as tagging the provided VPC with for-use-with-amazon-emr-managed-policies=true so that if you‚Äôre creating EMR clusters from Studio, the necessary resources can be created.\nIf you‚Äôre creating a Studio environment from scratch, there is also an EMR Studio Samples GitHub repository that provides CloudFormation templates for creating an environment as well as a sample Apache Airflow DAG for triggering EMR on EKS jobs.\nI won‚Äôt dive too deep into this because it‚Äôs again about 600 lines of Python code (largely IAM policies), but this is the CDK code that creates the EMR Studio.\nstudio = emr.CfnStudio( self, construct_id, name=name, auth_mode=\"SSO\", vpc_id=vpc.vpc_id, default_s3_location=studio_bucket.s3_url_for_object(), engine_security_group_id=engine_sg.security_group_id, workspace_security_group_id=workspace_sg.security_group_id, service_role=service_role.role_arn, user_role=user_role.role_arn, subnet_ids=vpc.select_subnets().subnet_ids, ) Deploying Prerequisites  Node =14.x and CDK Python = 3.9 and virtualenv An IAM role you want to grant admin access to EKS AWS SSO configured in the AWS Region where you are deploying  A user in SSO you want to grant access to EMR Studio   kubectl if you wish to access the Kubernetes Dashboard  Setup  Clone my demo-code repository and cd into the cdk/big-data-stack directory  git clone https://github.com/dacort/demo-code.git cd demo-code/cdk/big-data-stack  Create a Python virtualenv and install the necessary dependencies  virtualenv -p python3 .venv source .venv/bin/activate pip install -r requirements.txt Deploy  Bootstrap CDK for the AWS account and Region you want to deploy in  cdk bootstrap aws://account/region  Deploy your big data stack!  eks_admin_role_name is the IAM role you want to have admin access to EKS studio_admin_user_name is the AWS SSO user you want to grant access to EMR Studio    cdk deploy --all -c eks_admin_role_name=Admin -c studio_admin_user_name=dacort This will synthesize your stack into a set of CloudFormation templates and then roll out each piece of the stack.\nIf everything goes well, you should get a set of big green checkmarks!\nEach stack may also print out a set of ‚ÄúOutputs‚Äù and there are three in particular I want to highlight.\n EMRContainers.EMRVirtualClusterID = abcdefghijklmno1234567890  This is the ID of your EMR virtual cluster - you‚Äôll need this to run jobs.\n EMRContainers.JobRoleArn = arn:aws:iam::012345678912:role/emr_eks_default_role  This is the IAM role created in the EMRContainers stack that you can use to run your EMR on EKS jobs.\nEKSStack.EksForSparkConfigCommandABCD1234 = aws eks update-kubeconfig --name data-team --region us-east-2 --role-arn arn:aws:iam::012345678912:role/EKSStack-EksForSparkMastersRoleABCD1234-ABCDEF123456  This is the command you can use to add the new EKS cluster to your kubeconfig file so you can use kubectl commands.\nAccess the Kubernetes Dashboard We want to be able to inspect pods and other resources on our clusters. In order to do that, we need to use kubectl to proxy location connections to the EKS cluster.\nFirst, run the command in the EKSStack.EksForSparkConfigCommandABCD1234 output above. Then, use kubectl proxy.\n‚ûú kubectl proxy Starting to serve on 127.0.0.1:8001 Next, fetch a token that you can use to login to the Dashboard.\nSECRET_NAME=$(kubectl -n kube-system get secret | grep eks-admin | awk '{print $1}') TOKEN=$(kubectl -n kube-system describe secret $SECRET_NAME | grep -E '^token' | cut -f2 -d':' | tr -d \" \") echo $TOKEN Copy the value that‚Äôs output, open up the following URL in your browser, and paste the token where it says ‚ÄúEnter token *‚Äù\nhttp://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:https/proxy/#!/login\n A quick note about the URL above. It is constructed dynamically from the namespace and service names used in the kubernetes-dashboard helm chart. We‚Äôve defined the fullnameOverride value in the config for that chart or else the service name would be dynamic.\n Now that you‚Äôre logged in, you should be able to browse to the ‚ÄúPods‚Äù section and select emr-jobs from the namespace dropdown next to the search box. You won‚Äôt have any pods yet, but they‚Äôll show up there when you run a job.\nRun a job With everything all deployed, you should be able to run a sample job through EMR on EKS.\n Note that the values of virtual-cluster-id and execution-role-arn can be obtained from the values output by your cdk deploy command\n EMRContainers.EMRVirtualClusterID = abcdefghijklmno1234567890 EMRContainers.JobRoleArn = arn:aws:iam::012345678912:role/emr_eks_default_role Take those values and replace in the job below!\nexport EMR_EKS_CLUSTER_ID= export EMR_EKS_EXECUTION_ARN= aws emr-containers start-job-run \\  --virtual-cluster-id ${EMR_EKS_CLUSTER_ID} \\  --name pi-test \\  --execution-role-arn ${EMR_EKS_EXECUTION_ARN} \\  --release-label emr-6.3.0-latest \\  --job-driver '{ \"sparkSubmitJobDriver\": { \"entryPoint\": \"local:///usr/lib/spark/examples/src/main/python/pi.py\", \"sparkSubmitParameters\": \"--conf spark.executor.instances=1 --conf spark.executor.memory=2G --conf spark.executor.cores=1 --conf spark.driver.cores=1\" } }' { \"id\": \"0000000abcdef123456\", \"name\": \"pi-test\", \"arn\": \"arn:aws:emr-containers:us-east-2:012345678912:/virtualclusters/abcdefghijklmno1234567890/jobruns/0000000abcdef123456\", \"virtualClusterId\": \"abcdefghijklmno1234567890\" } Wrapup Take a look at my EMR on EKS playlists for more examples.\nAnd if you installed the EMR Studio stack, you can see your Studio URL in the EMRStudio.EMRStudioURL variable, or you can list your Studios and the access URL via the aws emr list-studios command.\naws emr list-studios { \"Studios\": [ { \"StudioId\": \"es-01234567890ABCDEFGHIJKLMN\", \"Name\": \"big-data-studio\", \"VpcId\": \"vpc-abcdef012345678901\", \"Url\": \"https://es-01234567890ABCDEFGHIJKLMN.emrstudio-prod.us-east-1.amazonaws.com\", \"CreationTime\": \"2021-06-02T16:20:56.548000-07:00\" } ] } ","wordCount":"1751","inLanguage":"en","image":"https://dacort.dev/images/cdk-big-data-stack-cover.jpg","datePublished":"2021-06-18T21:59:00-07:00","dateModified":"2021-06-18T21:59:00-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://dacort.dev/posts/cdk-big-data-stack/"},"publisher":{"@type":"Organization","name":"Damon Cortesi","logo":{"@type":"ImageObject","url":"https://dacort.dev/images/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://dacort.dev/ accesskey=h title="Damon Cortesi (Alt + H)">Damon Cortesi</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://dacort.dev/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://dacort.dev/posts/ title=Blog><span>Blog</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dacort.dev/>Home</a>&nbsp;¬ª&nbsp;<a href=https://dacort.dev/posts/>Posts</a></div><h1 class=post-title>Big Data Stack with CDK</h1><div class=post-description>How I built my own Apache Spark environment on AWS using Amazon EMR, Amazon EKS, and the AWS Cloud Development Kit (CDK).</div><div class=post-meta>June 18, 2021&nbsp;¬∑&nbsp;9 min</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a></li><li><a href=#vpc aria-label=VPC>VPC</a></li><li><a href=#eksstack aria-label=EKSStack>EKSStack</a><ul><li><a href=#cluster-autoscaler aria-label="Cluster Autoscaler">Cluster Autoscaler</a></li><li><a href=#kubernetes-dashboard aria-label="Kubernetes Dashboard">Kubernetes Dashboard</a></li></ul></li><li><a href=#emrcontainersstack aria-label=EMRContainersStack>EMRContainersStack</a></li><li><a href=#emrstudio aria-label=EMRStudio>EMRStudio</a></li><li><a href=#deploying aria-label=Deploying>Deploying</a><ul><li><a href=#prerequisites aria-label=Prerequisites>Prerequisites</a></li><li><a href=#setup aria-label=Setup>Setup</a></li><li><a href=#deploy aria-label=Deploy>Deploy</a></li><li><a href=#access-the-kubernetes-dashboard aria-label="Access the Kubernetes Dashboard">Access the Kubernetes Dashboard</a></li><li><a href=#run-a-job aria-label="Run a job">Run a job</a></li></ul></li><li><a href=#wrapup aria-label=Wrapup>Wrapup</a></li></ul></div></details></div><div class=post-content><p>I wanted to write a post about how I built my own Apache Spark environment on AWS using Amazon EMR, Amazon EKS, and the AWS Cloud Development Kit (CDK). This stack also creates an EMR Studio environment that can be used to build and deploy data notebooks.</p><p><em>Disclaimer: I work for AWS on the EMR team and built this stack for my <a href=https://www.youtube.com/channel/UCKtlXVZC2DqzayRlZYLObZw>various demos</a> and it is not intended for production use-cases.</em> üôè</p><p>Also note that the commands below are for demonstration purposes only, the full code is available in my <a href=https://github.com/dacort/demo-code/tree/main/cdk/big-data-stack>demo-code/cdk/big-data-stack</a> repository.</p><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>At re:Invent 2020, AWS introduced EMR on EKS - a way to run Apache Spark workloads on Kubernetes using managed services. Once you&rsquo;re up and running, you can submit a Spark job to EMR on EKS with a single AWS CLI command. But provisioning EKS, ensuring it has all the necessary resources to run your jobs, creating IAM roles and Kubernetes service accounts, and linking those back to EMR can be a lot of manual effort. Using AWS CDK, we can easily provision the entire stack:</p><ul><li>A VPC in 3 availability zones</li><li>An EKS cluster with the following addons<ul><li>Cluster Autoscaler</li><li>Kubernetes Dashboard</li></ul></li><li>An EMR virtual cluster connected to our EKS cluster</li><li>An EMR Studio environment<ul><li>A Service Catalog cluster template</li></ul></li></ul><p>This is the high-level architecture of what the resulting stack will look like. Now let&rsquo;s walk through each different piece.</p><p><img loading=lazy src=/images/cdk-big-data-stack-arch.png alt="CDK Big Data Stack architecture"></p><h2 id=vpc>VPC<a hidden class=anchor aria-hidden=true href=#vpc>#</a></h2><p>This is probably the easiest part of the whole setup. In CDK, you can provision a VPC with the following code:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> aws_cdk <span style=color:#f92672>import</span> aws_ec2 <span style=color:#66d9ef>as</span> ec2

ec2<span style=color:#f92672>.</span>Vpc(self, <span style=color:#e6db74>&#34;EMRDemos&#34;</span>, max_azs<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>)
</code></pre></div><p>And you&rsquo;re done. üéâ In my stack, I make the resulting <code>ec2.Vpc</code> object an attribute on the VPC stack so I can use it in other parts of my stack.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>app <span style=color:#f92672>=</span> cdk<span style=color:#f92672>.</span>App()

vpc <span style=color:#f92672>=</span> VPCStack(app, <span style=color:#e6db74>&#34;VPCStack&#34;</span>)
eks <span style=color:#f92672>=</span> EKSStack(app, <span style=color:#e6db74>&#34;EKSStack&#34;</span>, vpc<span style=color:#f92672>.</span>vpc)
emr_containers <span style=color:#f92672>=</span> EMRContainersStack(app, <span style=color:#e6db74>&#34;EMRContainers&#34;</span>, vpc<span style=color:#f92672>.</span>vpc, eks<span style=color:#f92672>.</span>cluster)
emr_studio <span style=color:#f92672>=</span> EMRStudio(app, <span style=color:#e6db74>&#34;EMRStudio&#34;</span>, vpc<span style=color:#f92672>.</span>vpc, <span style=color:#e6db74>&#34;big-data-studio&#34;</span>)

app<span style=color:#f92672>.</span>synth()
</code></pre></div><p>Let&rsquo;s walk through what happens in each of these stacks.</p><h2 id=eksstack>EKSStack<a hidden class=anchor aria-hidden=true href=#eksstack>#</a></h2><p>This one is a little more complex. In many cases, you only need to stand up your EKS cluster once and you&rsquo;ll use that in perpetuity. But there certainly are cases where you might provision multiple EKS stacks for security or organizational reasons. Provisioning an EKS stack in CDK is relatively straightforward.</p><ul><li>First, provision the EKS Cluster</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> aws_cdk <span style=color:#f92672>import</span> (
    aws_eks <span style=color:#66d9ef>as</span> eks,
    aws_ec2 <span style=color:#66d9ef>as</span> ec2,
    aws_iam <span style=color:#66d9ef>as</span> iam,
)

cluster <span style=color:#f92672>=</span> eks<span style=color:#f92672>.</span>Cluster(
    self,
    <span style=color:#e6db74>&#34;EksForSpark&#34;</span>,
    cluster_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;data-team&#34;</span>,
    version<span style=color:#f92672>=</span>eks<span style=color:#f92672>.</span>KubernetesVersion<span style=color:#f92672>.</span>V1_19,
    default_capacity<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
    endpoint_access<span style=color:#f92672>=</span>eks<span style=color:#f92672>.</span>EndpointAccess<span style=color:#f92672>.</span>PUBLIC_AND_PRIVATE,
    vpc<span style=color:#f92672>=</span>vpc,
    vpc_subnets<span style=color:#f92672>=</span>[ec2<span style=color:#f92672>.</span>SubnetSelection(subnet_type<span style=color:#f92672>=</span>ec2<span style=color:#f92672>.</span>SubnetType<span style=color:#f92672>.</span>PRIVATE)],
)
</code></pre></div><ul><li>Then, add one or more <a href=https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html>managed node groups</a>.</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>nodegroup <span style=color:#f92672>=</span> cluster<span style=color:#f92672>.</span>add_nodegroup_capacity(
    <span style=color:#e6db74>&#34;base-node-group&#34;</span>,
    instance_types<span style=color:#f92672>=</span>[ec2<span style=color:#f92672>.</span>InstanceType(<span style=color:#e6db74>&#34;m5.xlarge&#34;</span>)],     <span style=color:#75715e># You could add additional instance types here</span>
    min_size<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,                                         <span style=color:#75715e># The node group can scale to 1</span>
    max_size<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span>,                                        <span style=color:#75715e># And up to 20 nodes</span>
    disk_size<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span>,                                       <span style=color:#75715e># Give each node 50gb of disk</span>
)
</code></pre></div><ul><li>You&rsquo;ll also likely want to grant an IAM role admin access to the cluster</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>admin_iam_role_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Admin&#34;</span>           <span style=color:#75715e># This role must already exist in your AWS account</span>
account_id <span style=color:#f92672>=</span> cdk<span style=color:#f92672>.</span>Aws<span style=color:#f92672>.</span>ACCOUNT_ID
admin_role <span style=color:#f92672>=</span> iam<span style=color:#f92672>.</span>Role<span style=color:#f92672>.</span>from_role_arn(
    self, <span style=color:#e6db74>&#34;admin_role&#34;</span>, f<span style=color:#e6db74>&#34;arn:aws:iam::{account_id}:role/{admin_role_name}&#34;</span>
)
cluster<span style=color:#f92672>.</span>aws_auth<span style=color:#f92672>.</span>add_masters_role(admin_role)
</code></pre></div><h3 id=cluster-autoscaler>Cluster Autoscaler<a hidden class=anchor aria-hidden=true href=#cluster-autoscaler>#</a></h3><p>Finally, a critical component to install is the <a href=https://docs.aws.amazon.com/eks/latest/userguide/cluster-autoscaler.html>Cluster Autoscaler</a>. The EKS documentation shows how to deploy it using the <code>kubectl</code> command, but I wanted to wrap this up in the CDK stack. I also ran into <a href=https://github.com/kubernetes/autoscaler/issues/3901>this issue</a> where a Helm chart for 1.19 doesn&rsquo;t exist. üôÅ.</p><p>So I created an <a href=https://github.com/dacort/demo-code/blob/main/cdk/big-data-stack/plugins/eks/autoscaler.py>autoscaler module</a> that I can easily apply to my cluster and node groups.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>cluster_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;data-team&#34;</span>

ClusterAutoscaler(
    cluster_name, self, cluster, [nodegroup]
)<span style=color:#f92672>.</span>enable_autoscaling()
</code></pre></div><p>This code performs the following steps in order to enable the cluster autoscaler on an EKS cluster:</p><ul><li>Adds tags to the passed node groups to enable auto discovery</li><li>Creates a new IAM Role that can change Auto Scaling Groups</li><li>Creates a Kubernetes service account</li><li>Creates a new cluster-autoscaler deployment</li><li>Creates the corresponding rbac rules</li></ul><h3 id=kubernetes-dashboard>Kubernetes Dashboard<a hidden class=anchor aria-hidden=true href=#kubernetes-dashboard>#</a></h3><p>The Kubernetes Dashboard is also extremely valuable to be able to examine what&rsquo;s happening in your EKS cluster. It&rsquo;s easy to install by using the CDK <code>add_helm_chart</code> functionality.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>chart <span style=color:#f92672>=</span> cluster<span style=color:#f92672>.</span>add_helm_chart(
    <span style=color:#e6db74>&#34;kubernetes-dashboard&#34;</span>,
    namespace<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;kubernetes-dashboard&#34;</span>,
    chart<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;kubernetes-dashboard&#34;</span>,
    repository<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://kubernetes.github.io/dashboard/&#34;</span>,
    values<span style=color:#f92672>=</span>{
        <span style=color:#e6db74>&#34;fullnameOverride&#34;</span>: <span style=color:#e6db74>&#34;kubernetes-dashboard&#34;</span>,  <span style=color:#75715e># This must be set to acccess the UI via `kubectl proxy`</span>
        <span style=color:#e6db74>&#34;extraArgs&#34;</span>: [<span style=color:#e6db74>&#34;--token-ttl=0&#34;</span>],              <span style=color:#75715e># This prevents your access token from expiring, but is not intended for a production environment</span>
    },
)
</code></pre></div><p>üíÅ Note that I&rsquo;m setting <code>--token-ttl=0</code> so I don&rsquo;t have to re-sign in to the Dashboard every 10(!) minutes, but you shouldn&rsquo;t use this in a production environment. There&rsquo;s some more info about <a href=https://blinkeye.github.io/post/public/2019-05-30-kubernetes-dashboard/>adjusting the timeout the dashboard here</a>.</p><h2 id=emrcontainersstack>EMRContainersStack<a hidden class=anchor aria-hidden=true href=#emrcontainersstack>#</a></h2><p>A pre-requisite to running EMR on EKS is that you have to map the <code>AWSServiceRoleForAmazonEMRContainers</code> role to the EKS cluster. In order to prevent a circular dependency, I ended up doing this in the EKS stack.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>service_role_name <span style=color:#f92672>=</span> f<span style=color:#e6db74>&#34;arn:aws:iam::{cdk.Aws.ACCOUNT_ID}:role/AWSServiceRoleForAmazonEMRContainers&#34;</span>
emrsvcrole <span style=color:#f92672>=</span> iam<span style=color:#f92672>.</span>Role<span style=color:#f92672>.</span>from_role_arn(
    self, <span style=color:#e6db74>&#34;EmrSvcRole&#34;</span>, service_role_name, mutable<span style=color:#f92672>=</span>False
)
cluster<span style=color:#f92672>.</span>aws_auth<span style=color:#f92672>.</span>add_role_mapping(
    emrsvcrole, groups<span style=color:#f92672>=</span>[], username<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;emr-containers&#34;</span>
)
</code></pre></div><p><a href=https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up.html>Setting up EMR on EKS</a> requires several steps:</p><ul><li>Create a namespace for EMR to use</li><li>Create a k8s cluster role for EMR</li><li>Bind the cluster role to the <code>emr-containers</code> user we created above</li><li>Create a (nicely-named) job execution role</li><li>And then create our EMR virtual cluster</li></ul><p>If you want to <a href=https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-studio-create-eks-cluster.html>use EMR Studio with EMR on EKS</a>, you can also (optionally) create a managed endpoint. I don&rsquo;t quite have this fully automated with CDK yet.</p><p>I won&rsquo;t detail the whole setup here because it&rsquo;s about 400 lines of Python code, but you can see my <a href=https://github.com/dacort/demo-code/blob/main/cdk/big-data-stack/stacks/eks.py>EMR on EKS Stack</a> on GitHub.</p><p>‚ö†Ô∏è One thing to call out is that inside the <code>create_job_execution_role</code> method, we create a new job role we can use to run our jobs on EMR on EKS. This role is, admittedly, way overscoped and allows full access to S3, EC2, Glue, and CloudWatch. It is heavily recommended that you scope down the permissions this role has.</p><h2 id=emrstudio>EMRStudio<a hidden class=anchor aria-hidden=true href=#emrstudio>#</a></h2><p><a href=https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-studio-set-up.html>Setting up EMR Studio</a> requires the creation of several Studio-specific IAM roles, an S3 bucket for Studio assets, and mapping an AWS SSO user to the Studio.</p><p>The <code>EMRStudio</code> stack performs all these steps as well as tagging the provided VPC with <code>for-use-with-amazon-emr-managed-policies=true</code> so that if you&rsquo;re creating EMR clusters from Studio, the necessary resources can be created.</p><p>If you&rsquo;re creating a Studio environment from scratch, there is also an <a href=https://github.com/aws-samples/emr-studio-samples>EMR Studio Samples</a> GitHub repository that provides CloudFormation templates for creating an environment as well as a sample Apache Airflow DAG for triggering EMR on EKS jobs.</p><p>I won&rsquo;t dive too deep into this because it&rsquo;s again about 600 lines of Python code (largely IAM policies), but this is the CDK code that creates the EMR Studio.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>studio <span style=color:#f92672>=</span> emr<span style=color:#f92672>.</span>CfnStudio(
    self,
    construct_id,
    name<span style=color:#f92672>=</span>name,
    auth_mode<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;SSO&#34;</span>,
    vpc_id<span style=color:#f92672>=</span>vpc<span style=color:#f92672>.</span>vpc_id,
    default_s3_location<span style=color:#f92672>=</span>studio_bucket<span style=color:#f92672>.</span>s3_url_for_object(),
    engine_security_group_id<span style=color:#f92672>=</span>engine_sg<span style=color:#f92672>.</span>security_group_id,
    workspace_security_group_id<span style=color:#f92672>=</span>workspace_sg<span style=color:#f92672>.</span>security_group_id,
    service_role<span style=color:#f92672>=</span>service_role<span style=color:#f92672>.</span>role_arn,
    user_role<span style=color:#f92672>=</span>user_role<span style=color:#f92672>.</span>role_arn,
    subnet_ids<span style=color:#f92672>=</span>vpc<span style=color:#f92672>.</span>select_subnets()<span style=color:#f92672>.</span>subnet_ids,
)
</code></pre></div><h2 id=deploying>Deploying<a hidden class=anchor aria-hidden=true href=#deploying>#</a></h2><h3 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h3><ul><li>Node >=14.x and <a href=https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html>CDK</a></li><li>Python >= 3.9 and <a href=https://docs.python-guide.org/dev/virtualenvs/#lower-level-virtualenv>virtualenv</a></li><li>An IAM role you want to grant admin access to EKS</li><li><a href=https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-studio-enable-sso.html>AWS SSO configured</a> in the AWS Region where you are deploying<ul><li>A user in SSO you want to grant access to EMR Studio</li></ul></li><li><a href=https://kubernetes.io/docs/tasks/tools/>kubectl</a> if you wish to access the Kubernetes Dashboard</li></ul><h3 id=setup>Setup<a hidden class=anchor aria-hidden=true href=#setup>#</a></h3><ul><li>Clone my <a href=https://github.com/dacort/demo-code><code>demo-code</code></a> repository and <code>cd</code> into the <code>cdk/big-data-stack</code> directory</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/dacort/demo-code.git
cd demo-code/cdk/big-data-stack
</code></pre></div><ul><li>Create a Python virtualenv and install the necessary dependencies</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>virtualenv -p python3 .venv
source .venv/bin/activate
pip install -r requirements.txt
</code></pre></div><h3 id=deploy>Deploy<a hidden class=anchor aria-hidden=true href=#deploy>#</a></h3><ul><li>Bootstrap CDK for the AWS account and Region you want to deploy in</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cdk bootstrap aws://account/region
</code></pre></div><ul><li>Deploy your big data stack!<ul><li><code>eks_admin_role_name</code> is the IAM role you want to have admin access to EKS</li><li><code>studio_admin_user_name</code> is the AWS SSO user you want to grant access to EMR Studio</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cdk deploy --all -c eks_admin_role_name<span style=color:#f92672>=</span>Admin -c studio_admin_user_name<span style=color:#f92672>=</span>dacort
</code></pre></div><p>This will synthesize your stack into a set of CloudFormation templates and then roll out each piece of the stack.</p><p>If everything goes well, you should get a set of big green checkmarks!</p><p>Each stack may also print out a set of &ldquo;Outputs&rdquo; and there are three in particular I want to highlight.</p><ol><li><code>EMRContainers.EMRVirtualClusterID = abcdefghijklmno1234567890</code></li></ol><p>This is the ID of your EMR virtual cluster - you&rsquo;ll need this to run jobs.</p><ol><li><code>EMRContainers.JobRoleArn = arn:aws:iam::012345678912:role/emr_eks_default_role</code></li></ol><p>This is the IAM role created in the <code>EMRContainers</code> stack that you can use to run your EMR on EKS jobs.</p><ol start=2><li><code>EKSStack.EksForSparkConfigCommandABCD1234 = aws eks update-kubeconfig --name data-team --region us-east-2 --role-arn arn:aws:iam::012345678912:role/EKSStack-EksForSparkMastersRoleABCD1234-ABCDEF123456</code></li></ol><p>This is the command you can use to add the new EKS cluster to your kubeconfig file so you can use <code>kubectl</code> commands.</p><h3 id=access-the-kubernetes-dashboard>Access the Kubernetes Dashboard<a hidden class=anchor aria-hidden=true href=#access-the-kubernetes-dashboard>#</a></h3><p>We want to be able to inspect pods and other resources on our clusters. In order to do that, we need to use <code>kubectl</code> to proxy location connections to the EKS cluster.</p><p>First, run the command in the <code>EKSStack.EksForSparkConfigCommandABCD1234</code> output above. Then, use <code>kubectl proxy</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>‚ûú kubectl proxy
Starting to serve on 127.0.0.1:8001
</code></pre></div><p>Next, fetch a token that you can use to login to the Dashboard.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>SECRET_NAME<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>kubectl -n kube-system get secret | grep eks-admin | awk <span style=color:#e6db74>&#39;{print $1}&#39;</span><span style=color:#66d9ef>)</span>
TOKEN<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>kubectl -n kube-system describe secret $SECRET_NAME | grep -E <span style=color:#e6db74>&#39;^token&#39;</span> | cut -f2 -d<span style=color:#e6db74>&#39;:&#39;</span> | tr -d <span style=color:#e6db74>&#34; &#34;</span><span style=color:#66d9ef>)</span>

echo $TOKEN
</code></pre></div><p>Copy the value that&rsquo;s output, open up the following URL in your browser, and paste the token where it says &ldquo;Enter token *&rdquo;</p><p><a href=http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:https/proxy/#!/login>http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:https/proxy/#!/login</a></p><p><img loading=lazy src=k8s-dashboard-login.png alt></p><blockquote><p>A quick note about the URL above. It is constructed dynamically from the namespace and service names used in the kubernetes-dashboard helm chart. We&rsquo;ve defined the <code>fullnameOverride</code> value in the config for that chart or else the service name would be dynamic.</p></blockquote><p>Now that you&rsquo;re logged in, you should be able to browse to the &ldquo;Pods&rdquo; section and select <code>emr-jobs</code> from the namespace dropdown next to the search box. You won&rsquo;t have any pods yet, but they&rsquo;ll show up there when you run a job.</p><h3 id=run-a-job>Run a job<a hidden class=anchor aria-hidden=true href=#run-a-job>#</a></h3><p>With everything all deployed, you should be able to run a sample job through EMR on EKS.</p><blockquote><p>Note that the values of <code>virtual-cluster-id</code> and <code>execution-role-arn</code> can be obtained from the values output by your <code>cdk deploy command</code></p></blockquote><pre><code>EMRContainers.EMRVirtualClusterID = abcdefghijklmno1234567890
EMRContainers.JobRoleArn = arn:aws:iam::012345678912:role/emr_eks_default_role
</code></pre><p>Take those values and replace in the job below!</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>export EMR_EKS_CLUSTER_ID<span style=color:#f92672>=</span>&lt;EMRVirtualClusterID&gt;
export EMR_EKS_EXECUTION_ARN<span style=color:#f92672>=</span>&lt;JobRoleArn&gt;

aws emr-containers start-job-run <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --virtual-cluster-id <span style=color:#e6db74>${</span>EMR_EKS_CLUSTER_ID<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --name pi-test <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --execution-role-arn <span style=color:#e6db74>${</span>EMR_EKS_EXECUTION_ARN<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --release-label emr-6.3.0-latest <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --job-driver <span style=color:#e6db74>&#39;{
</span><span style=color:#e6db74>        &#34;sparkSubmitJobDriver&#34;: {
</span><span style=color:#e6db74>            &#34;entryPoint&#34;: &#34;local:///usr/lib/spark/examples/src/main/python/pi.py&#34;,
</span><span style=color:#e6db74>            &#34;sparkSubmitParameters&#34;: &#34;--conf spark.executor.instances=1 --conf spark.executor.memory=2G --conf spark.executor.cores=1 --conf spark.driver.cores=1&#34;
</span><span style=color:#e6db74>        }
</span><span style=color:#e6db74>    }&#39;</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;0000000abcdef123456&#34;</span>,
    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;pi-test&#34;</span>,
    <span style=color:#f92672>&#34;arn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:emr-containers:us-east-2:012345678912:/virtualclusters/abcdefghijklmno1234567890/jobruns/0000000abcdef123456&#34;</span>,
    <span style=color:#f92672>&#34;virtualClusterId&#34;</span>: <span style=color:#e6db74>&#34;abcdefghijklmno1234567890&#34;</span>
}
</code></pre></div><h2 id=wrapup>Wrapup<a hidden class=anchor aria-hidden=true href=#wrapup>#</a></h2><p>Take a look at my <a href="https://www.youtube.com/watch?v=2UMz72NRZss&list=PLUe6KRx8LhLpJ8CyNHewFYukWm7sQyQrM">EMR on EKS playlists</a> for more examples.</p><p>And if you installed the EMR Studio stack, you can see your Studio URL in the <code>EMRStudio.EMRStudioURL</code> variable, or you can list your Studios and the access URL via the <code>aws emr list-studios</code> command.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>aws emr list-studios
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;Studios&#34;</span>: [
        {
            <span style=color:#f92672>&#34;StudioId&#34;</span>: <span style=color:#e6db74>&#34;es-01234567890ABCDEFGHIJKLMN&#34;</span>,
            <span style=color:#f92672>&#34;Name&#34;</span>: <span style=color:#e6db74>&#34;big-data-studio&#34;</span>,
            <span style=color:#f92672>&#34;VpcId&#34;</span>: <span style=color:#e6db74>&#34;vpc-abcdef012345678901&#34;</span>,
            <span style=color:#f92672>&#34;Url&#34;</span>: <span style=color:#e6db74>&#34;https://es-01234567890ABCDEFGHIJKLMN.emrstudio-prod.us-east-1.amazonaws.com&#34;</span>,
            <span style=color:#f92672>&#34;CreationTime&#34;</span>: <span style=color:#e6db74>&#34;2021-06-02T16:20:56.548000-07:00&#34;</span>
        }
    ]
}
</code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://dacort.dev/tags/aws/>aws</a></li><li><a href=https://dacort.dev/tags/emr/>emr</a></li><li><a href=https://dacort.dev/tags/cdk/>cdk</a></li><li><a href=https://dacort.dev/tags/aws-cdk/>aws-cdk</a></li><li><a href=https://dacort.dev/tags/python/>python</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Big Data Stack with CDK on twitter" href="https://twitter.com/intent/tweet/?text=Big%20Data%20Stack%20with%20CDK&url=https%3a%2f%2fdacort.dev%2fposts%2fcdk-big-data-stack%2f&hashtags=aws%2cemr%2ccdk%2caws-cdk%2cpython"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Big Data Stack with CDK on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fdacort.dev%2fposts%2fcdk-big-data-stack%2f&title=Big%20Data%20Stack%20with%20CDK&summary=Big%20Data%20Stack%20with%20CDK&source=https%3a%2f%2fdacort.dev%2fposts%2fcdk-big-data-stack%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Big Data Stack with CDK on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fdacort.dev%2fposts%2fcdk-big-data-stack%2f&title=Big%20Data%20Stack%20with%20CDK"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Big Data Stack with CDK on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fdacort.dev%2fposts%2fcdk-big-data-stack%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Big Data Stack with CDK on whatsapp" href="https://api.whatsapp.com/send?text=Big%20Data%20Stack%20with%20CDK%20-%20https%3a%2f%2fdacort.dev%2fposts%2fcdk-big-data-stack%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Big Data Stack with CDK on telegram" href="https://telegram.me/share/url?text=Big%20Data%20Stack%20with%20CDK&url=https%3a%2f%2fdacort.dev%2fposts%2fcdk-big-data-stack%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://dacort.dev/>Damon Cortesi</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body></html>
<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Build your own Air Quality Monitor with OpenAQ and EMR on EKS | Damon Cortesi</title>
<meta name=keywords content="emr,eks,aws"><meta name=description content="Fire season is closely approaching and as somebody that spent two weeks last year hunkered down inside with my browser glued to various air quality sites, I wanted to show how to use data from OpenAQ to build your own air quality analysis.
With Amazon EMR on EKS, you can now customize and package your own Apache Spark dependencies and I use that functionality for this post.
Overview OpenAQ maintains a publicly accessible dataset of various air quality metrics that&rsquo;s updated every half hour."><meta name=author content><link rel=canonical href=https://dacort.dev/posts/emr-eks-custom-images-with-openaq/><link crossorigin=anonymous href=/assets/css/stylesheet.6b531e890e49fe4a371a413e1bfb6e0e4541db1c9dd1cc21ecbc00dd44f03f6e.css integrity="sha256-a1MeiQ5J/ko3GkE+G/tuDkVB2xyd0cwh7LwA3UTwP24=" rel="preload stylesheet" as=style><link rel=icon href=https://dacort.dev/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dacort.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dacort.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://dacort.dev/apple-touch-icon.png><link rel=mask-icon href=https://dacort.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Build your own Air Quality Monitor with OpenAQ and EMR on EKS"><meta property="og:description" content="Fire season is closely approaching and as somebody that spent two weeks last year hunkered down inside with my browser glued to various air quality sites, I wanted to show how to use data from OpenAQ to build your own air quality analysis.
With Amazon EMR on EKS, you can now customize and package your own Apache Spark dependencies and I use that functionality for this post.
Overview OpenAQ maintains a publicly accessible dataset of various air quality metrics that&rsquo;s updated every half hour."><meta property="og:type" content="article"><meta property="og:url" content="https://dacort.dev/posts/emr-eks-custom-images-with-openaq/"><meta property="og:image" content="https://dacort.dev/images/posts-airq.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-24T21:20:00+00:00"><meta property="article:modified_time" content="2021-06-24T21:20:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dacort.dev/images/posts-airq.png"><meta name=twitter:title content="Build your own Air Quality Monitor with OpenAQ and EMR on EKS"><meta name=twitter:description content="Fire season is closely approaching and as somebody that spent two weeks last year hunkered down inside with my browser glued to various air quality sites, I wanted to show how to use data from OpenAQ to build your own air quality analysis.
With Amazon EMR on EKS, you can now customize and package your own Apache Spark dependencies and I use that functionality for this post.
Overview OpenAQ maintains a publicly accessible dataset of various air quality metrics that&rsquo;s updated every half hour."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dacort.dev/posts/"},{"@type":"ListItem","position":2,"name":"Build your own Air Quality Monitor with OpenAQ and EMR on EKS","item":"https://dacort.dev/posts/emr-eks-custom-images-with-openaq/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Build your own Air Quality Monitor with OpenAQ and EMR on EKS","name":"Build your own Air Quality Monitor with OpenAQ and EMR on EKS","description":"Fire season is closely approaching and as somebody that spent two weeks last year hunkered down inside with my browser glued to various air quality sites, I wanted to show how to use data from OpenAQ to build your own air quality analysis.\nWith Amazon EMR on EKS, you can now customize and package your own Apache Spark dependencies and I use that functionality for this post.\nOverview OpenAQ maintains a publicly accessible dataset of various air quality metrics that\u0026rsquo;s updated every half hour.","keywords":["emr","eks","aws"],"articleBody":"Fire season is closely approaching and as somebody that spent two weeks last year hunkered down inside with my browser glued to various air quality sites, I wanted to show how to use data from OpenAQ to build your own air quality analysis.\nWith Amazon EMR on EKS, you can now customize and package your own Apache Spark dependencies and I use that functionality for this post.\nOverview OpenAQ maintains a publicly accessible dataset of various air quality metrics that’s updated every half hour. Bokeh is a popular library for Python data visualization. While it includes sample data for US county and state boundaries, we’re going to use shapefiles from census.gov.\nWe’ll use an Apache Spark job on EMR on EKS to read the initial dataset from the S3 bucket, filter it for use case, and then combine it with the boundary data from census.gov in order to draw a map of the current air quality.\nThis post also shows how to use the custom containers support in EMR on EKS to build our own container image with the necessary dependencies.\nPre-requisites An AWS account with access to Amazon Elastic Container Registry (ECR) An EMR on EKS cluster already setup Docker A container registry to push your image to Building the EMR on EKS Container Image Download the EMR base image For this post, we’ll be using the us-west-2 region and EMR 6.3.0 release. Each region and release has a different base image URL, and you can find the full list here.\naws ecr get-login-password --region us-west-2 \\ | docker login --username AWS --password-stdin 895885662937.dkr.ecr.us-west-2.amazonaws.com docker pull 895885662937.dkr.ecr.us-west-2.amazonaws.com/notebook-spark/emr-6.3.0:latest Customize the image EMR on EKS comes with a variety of default libraries installed including plotly and seaborn, but we wanted to try out Bokeh for my illustration as they have a great choropleth example and it’s a library I’ve been hearing about occasionally. I was hoping to use Bokeh’s sampledata for US and county, but I ended up using GeoPandas to re-project my map to a conic projection so Michigan wasn’t squashed up against Wisconsin. :) GeoPandas makes it easy to read in shapefiles, so I just used the census.gov provided state and county data.\nBokeh also uses Selenium and Chrome for it’s static image generation, so we go ahead and install Chrome on the container image as well.\nFROM 895885662937.dkr.ecr.us-west-2.amazonaws.com/notebook-spark/emr-6.3.0:latest USER root # Install Chrome RUN curl https://intoli.com/install-google-chrome.sh | bash \u0026\u0026 \\ mv /usr/bin/google-chrome-stable /usr/bin/chrome # We need to upgrade pip in order to install pyproj RUN pip3 install --upgrade pip # If you pip install as root, use this RUN pip3 install \\ bokeh==2.3.2 \\ boto3==1.17.93 \\ chromedriver-py==91.0.4472.19.0 \\ geopandas==0.9.0 \\ selenium==3.141.0 \\ shapely==1.7.1 RUN ln -s /usr/local/lib/python3.7/site-packages/chromedriver_py/chromedriver_linux64 /usr/local/bin/chromedriver # Install bokeh sample data to /usr/local/share RUN mkdir /root/.bokeh \u0026\u0026 \\ echo \"sampledata_dir: /usr/local/share/bokeh\" \u003e /root/.bokeh/config \u0026\u0026 \\ bokeh sampledata # Also install census data into the image :) ADD https://www2.census.gov/geo/tiger/GENZ2020/shp/cb_2020_us_state_500k.zip /usr/local/share/bokeh/ ADD https://www2.census.gov/geo/tiger/GENZ2020/shp/cb_2020_us_county_500k.zip /usr/local/share/bokeh/ RUN chmod 644 /usr/local/share/bokeh/cb*.zip # This is a simple test to make sure generating the image works properly COPY test /test/ USER hadoop:hadoop Build and push Great, we’ve customized our image – now we just need to build and push it to a container registery somewhere! For this post, I chose GitHub but you can use any container registry like ECR or DockerHub.\nThe below commands assume you have a GitHub Personal Access Token that has access to push images in the CR_PAT environment variable.\ndocker build -t emr-6.3.0-bokeh:latest . export USERNAME=GH_USERNAME echo $CR_PAT| docker login ghcr.io -u ${USERNAME} --password-stdin docker tag emr-6.3.0-bokeh:latest ghcr.io/${USERNAME}/emr-6.3.0-bokeh:latest docker push ghcr.io/${USERNAME}/emr-6.3.0-bokeh:latest Great, now your image is ready to go! Let’s look at the code we’re going to use to generate our air quality map.\nCode walkthrough If you already built your image, you can run the below code locally. In order to access S3 data, you’ll have to set your AWS_ACCESS_KEY_ID and AWS_SECRET_KEY_ID environment variables.\ndocker run --rm -it --name airq-demo \\ -e AWS_ACCESS_KEY_ID \\ -e AWS_SECRET_ACCESS_KEY \\ emr-6.3.0-bokeh \\ pyspark --deploy-mode client --master 'local[1]' Reading and filtering OpenAQ Data The first thing we need to do is read the the data for today’s date into a Spark dataframe.\nimport datetime date = f\"{datetime.datetime.utcnow().date()}\" df = spark.read.json(f\"s3://openaq-fetches/realtime-gzipped/{date}/\") df.show() +--------------------+---------------+---------+--------------------+-------+--------------------+--------------------+------+---------+-----------------+----------+-----+-----+ | attribution|averagingPeriod| city| coordinates|country| date| location|mobile|parameter| sourceName|sourceType| unit|value| +--------------------+---------------+---------+--------------------+-------+--------------------+--------------------+------+---------+-----------------+----------+-----+-----+ |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-13T22:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 25.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-13T23:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 16.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T00:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 18.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T01:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 23.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T02:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 23.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T03:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 21.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T04:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 20.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T05:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 16.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T06:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 17.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T07:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 18.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T08:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 20.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T09:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 26.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T10:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 29.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T11:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 34.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T12:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 33.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T13:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 40.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T14:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 39.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T15:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 41.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T16:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 50.0| |[{EPA AirNow DOS,...| {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...| AE|{2021-06-14T17:00...|US Diplomatic Pos...| false| pm25|StateAir_AbuDhabi|government|µg/m³| 56.0| +--------------------+---------------+---------+--------------------+-------+--------------------+--------------------+------+---------+-----------------+----------+-----+-----+ We can quickly see a few things:\nData is provided from all over the globe, we just want US We have coordinates and country, but that’s it for location data There are multiple different types of readings There are multiple different readings per day per location df.select('unit', 'parameter').distinct().sort(\"parameter\").show() +-----+---------+ | unit|parameter| +-----+---------+ |µg/m³| bc| |µg/m³| co| | ppm| co| | ppm| no2| |µg/m³| no2| |µg/m³| o3| | ppm| o3| |µg/m³| pm10| |µg/m³| pm25| | ppm| so2| |µg/m³| so2| +-----+---------+ So, let’s go ahead and filter down to the most recent PM2.5 reading in the United States.\nTo do that, it’s a couple where filters and then we can utilize a window function (last) to get the last reading.\n# Filter down to US locations and PM2.5 readings only usdf = ( df.where(df.country == \"US\") .where(df.parameter == \"pm25\") .select(\"coordinates\", \"date\", \"parameter\", \"unit\", \"value\", \"location\") ) # Retrieve the most recent pm2.5 reading per county from pyspark.sql.window import Window from pyspark.sql.functions import last windowSpec = ( Window.partitionBy(\"location\") .orderBy(\"date.utc\") .rangeBetween(Window.unboundedPreceding, Window.unboundedFollowing) ) last_reading_df = ( usdf.withColumn(\"last_value\", last(\"value\").over(windowSpec)) .select(\"coordinates\", \"last_value\") .distinct() ) last_reading_df.show() We also only selected the coordinates and last_value columns as these are all we need at this point.\n+--------------------+----------+ | coordinates|last_value| +--------------------+----------+ |{38.6619, -121.7278}| 2.0| | {41.9767, -91.6878}| 4.9| |{39.54092, -119.7...| 8.0| |{43.629605, -72.3...| 9.0| |{46.8505, -111.98...| 10.0| |{39.818715, -75.4...| 8.5| +--------------------+----------+ Mapping coordinates to counties This was the most “fun” part of this journey. Bokeh provides some sample data and I initially just created a UDF that looked up the first county ID using the Polygon intersects method. Unfortunately, I then wanted to re-project the map to a conical projection (Albers). Bokeh’s geo support isn’t very strong, so I ended up looking at using GeoPandas to do the reprojection. That worked well, but the Bokeh county data wasn’t in a format I could use with GeoPandas so I ended up downloading Shapefiles from the Census Bureau.\nSo, we’ve got our last_reading_df dataframe. Lets map those coordinates to counties. The county data is relatively small (12mb zipped) so what I did was create a broadcast variable of GEOID -\u003e Geometry mappings that could be used in a UDF to figure out if a PM2.5 reading is inside a specific county.\nDownload the census data and create a broadcast variable import geopandas as gpd COUNTY_URL = 'https://www2.census.gov/geo/tiger/GENZ2020/shp/cb_2020_us_county_500k.zip' countydf = gpd.read_file(COUNTY_URL) bc_county = sc.broadcast(dict(zip(countydf[\"GEOID\"], countydf[\"geometry\"]))) countydf.head() We can see we’re just mapping the GEOID column to the geometry column which is a polygon object containing the county boundaries.\nSTATEFP COUNTYFP COUNTYNS AFFGEOID GEOID NAME NAMELSAD STUSPS STATE_NAME LSAD ALAND AWATER geometry 0 21 141 00516917 0500000US21141 21141 Logan Logan County KY Kentucky 06 1430224002 12479211 POLYGON ((-87.06037 36.68085, -87.06002 36.708... 1 36 081 00974139 0500000US36081 36081 Queens Queens County NY New York 06 281594050 188444349 POLYGON ((-73.96262 40.73903, -73.96243 40.739... 2 34 017 00882278 0500000US34017 34017 Hudson Hudson County NJ New Jersey 06 119640822 41836491 MULTIPOLYGON (((-74.04220 40.69997, -74.03900 ... 3 34 019 00882228 0500000US34019 34019 Hunterdon Hunterdon County NJ New Jersey 06 1108086284 24761598 POLYGON ((-75.19511 40.57969, -75.19466 40.581... 4 21 147 00516926 0500000US21147 21147 McCreary McCreary County KY Kentucky 06 1105416696 10730402 POLYGON ((-84.77845 36.60329, -84.73068 36.665... Create a UDF to find the county a coordinate is in This just brute forces the list of GEOIDs/polygons and returns the first GEOID that intersects. There is likely a more elegant to do this.\nfrom pyspark.sql.functions import udf from pyspark.sql.types import StringType from shapely.geometry import Point def find_first_county_id(longitude: float, latitude: float): p = Point(longitude, latitude) for index, geo in bc_county.value.items(): if geo.intersects(p): return index return None find_first_county_id_udf = udf(find_first_county_id, StringType()) Now we apply to the UDF to our last_reading_df dataframe # Find the county that this reading is from mapped_county_df = last_reading_df.withColumn( \"GEOID\", find_first_county_id_udf( last_reading_df.coordinates.longitude, last_reading_df.coordinates.latitude ), ).select(\"GEOID\", \"last_value\") And then finally we calculate the average PM2.5 value per county # Calculate the average reading per county pm_avg_by_county = ( mapped_county_df.groupBy(\"GEOID\") .agg({\"last_value\": \"avg\"}) .withColumnRenamed(\"avg(last_value)\", \"avg_value\") ) pm_avg_by_county.show(5) +-----+------------------+ |GEOID| avg_value| +-----+------------------+ |31157| 16.0| |49053| 3.0| |26153| 6.9| |36029| 1.1| |42101| 10.66| +-----+------------------+ Cool! So now we have a GEOID we can use in our GeoPandas dataframe and an average value of the most recent PM2.5 reading for that county.\nGenerating our Air Quality map Now that we’ve got an average PM2.5 value per county, we need to join this with our map data and generate an image!\nThe first step is reading in US State and County shapefiles. We fetched these from census.gov while building the image and they’re stored in /usr/local/share/bokeh. We also exclude any state not in the continental US.\nimport geopandas as gpd STATE_FILE = \"file:///usr/local/share/bokeh/cb_2020_us_state_500k.zip\" COUNTY_FILE = \"file:///usr/local/share/bokeh/cb_2020_us_county_500k.zip\" EXCLUDED_STATES = [\"AK\", \"HI\", \"PR\", \"GU\", \"VI\", \"MP\", \"AS\"] county_df = gpd.read_file(COUNTY_FILE).query(f\"STUSPS not in {EXCLUDED_STATES}\") state_df = gpd.read_file(STATE_FILE).query(f\"STUSPS not in {EXCLUDED_STATES}\") Now we just do a simple merge on the GeoPandas dataframe, convert our maps to the Albers projection and save them as JSON objects.\n# Merge in our air quality data county_aqi_df = county_df.merge(pm_avg_by_county.toPandas(), on=\"GEOID\") # Convert to a \"proper\" Albers projection :) state_json = state_df.to_crs(\"ESRI:102003\").to_json() county_json = county_aqi_df.to_crs(\"ESRI:102003\").to_json() Now comes the fun part! Our data is all prepped, we’ve averaged the most recent data by county, and built a GeoJSON file of everything we need. Let’s map it!\nI won’t go into the details of every line, but we’ll make use of Bokeh’s awesome GeoJSONDataSource functionality, add a LinearColorMapper that automatically shades the counties for us by the avg_value column using the Reds9 palette, and adds a ColorBar on the right-hand side.\nfrom bokeh.models import ColorBar, GeoJSONDataSource, LinearColorMapper from bokeh.palettes import Reds9 as palette from bokeh.plotting import figure p = figure( title=\"US Air Quality Data\", plot_width=1100, plot_height=700, toolbar_location=None, x_axis_location=None, y_axis_location=None, tooltips=[ (\"County\", \"@NAME\"), (\"Air Quality Index\", \"@avg_value\"), ], ) p.grid.grid_line_color = None # This just adds our state lines p.patches( \"xs\", \"ys\", fill_alpha=0.0, line_color=\"black\", line_width=0.5, source=GeoJSONDataSource(geojson=state_json), ) # Add our county data and shade them based on \"avg_value\" color_mapper = LinearColorMapper(palette=tuple(reversed(palette))) color_column = \"avg_value\" p.patches( \"xs\", \"ys\", fill_alpha=0.7, fill_color={\"field\": color_column, \"transform\": color_mapper}, line_color=\"black\", line_width=0.5, source=GeoJSONDataSource(geojson=county_json), ) # Now add a color bar legend on the right-hand side color_bar = ColorBar(color_mapper=color_mapper, label_standoff=12, width=10) p.add_layout(color_bar, \"right\") Finally, let’s go ahead export the png!\nfrom bokeh.io import export_png from bokeh.io.webdriver import create_chromium_webdriver driver = create_chromium_webdriver([\"--no-sandbox\"]) export_png(p, filename=\"map.png\", webdriver=driver) Now, if you’re running on a mac, you can just copy the generated map to your local system and open it up!\ndocker cp airq-demo:/home/hadoop/map.png . open map.png Running on EMR on EKS I’ve bundled this all up into a pyspark script in my demo-code repo.\nThis demo assumes you already have an EMR on EKS virtual cluster up and running, you’ve built the image in the first part and pushed it to a container registry, and the IAM Role you use to run the job has access to both read and write to an S3 bucket.\nFirst, download the generate_aqi_map.py code from the GitHub repo.\nThen, upload that script to an S3 bucket you have access to.\naws s3 cp generate_aqi_map.py s3:///code/ Now, just run your job! The pyspark script takes a few parameters:\n- The S3 bucket where you want to upload the generated image to - The prefix in the bucket where you want the image located --date 2021-01-01 (optional) - A specific date for which you want to generate data for Defaults to UTC today export S3_BUCKET= export EMR_EKS_CLUSTER_ID=abcdefghijklmno1234567890 export EMR_EKS_EXECUTION_ARN=arn:aws:iam::123456789012:role/emr_eks_default_role # Replace ghcr.io/OWNER/emr-6.3.0-bokeh:latest below with your image URL aws emr-containers start-job-run \\ --virtual-cluster-id ${EMR_EKS_CLUSTER_ID} \\ --name openaq-conus \\ --execution-role-arn ${EMR_EKS_EXECUTION_ARN} \\ --release-label emr-6.3.0-latest \\ --job-driver '{ \"sparkSubmitJobDriver\": { \"entryPoint\": \"s3://'${S3_BUCKET}'/code/generate_aqi_map.py\", \"entryPointArguments\": [\"'${S3_BUCKET}'\", \"output/airq/\"], \"sparkSubmitParameters\": \"--conf spark.kubernetes.container.image=ghcr.io/OWNER/emr-6.3.0-bokeh:latest\" } }' \\ --configuration-overrides '{ \"monitoringConfiguration\": { \"s3MonitoringConfiguration\": { \"logUri\": \"s3://'${S3_BUCKET}'/logs/\" } } }' { \"id\": \"0000000abcdefg12345\", \"name\": \"openaq-conus\", \"arn\": \"arn:aws:emr-containers:us-east-2:123456789012:/virtualclusters/abcdefghijklmno1234567890/jobruns/0000000abcdefg12345\", \"virtualClusterId\": \"abcdefghijklmno1234567890\" } While the job is running, you can get the fetch the status of the job using the emr-containers describe-job-run command.\naws emr-containers describe-job-run \\ --virtual-cluster-id ${EMR_EKS_CLUSTER_ID} \\ --id 0000000abcdefg12345 Once the job is in the COMPLETED state, you should be able to copy the resulting image from your S3 bucket!\naws s3 cp s3://${S3_BUCKET}/output/airq/2021-06-24-latest.png . And if you open that file, you’ll get the most recent PM2.5 readings!\nWrapup Be sure to check out the launch post for more details, the documentation for customing docker images for EMR on EKS, and my demo video.\n","wordCount":"2348","inLanguage":"en","image":"https://dacort.dev/images/posts-airq.png","datePublished":"2021-06-24T21:20:00Z","dateModified":"2021-06-24T21:20:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://dacort.dev/posts/emr-eks-custom-images-with-openaq/"},"publisher":{"@type":"Organization","name":"Damon Cortesi","logo":{"@type":"ImageObject","url":"https://dacort.dev/images/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dacort.dev/ accesskey=h title="Damon Cortesi (Alt + H)">Damon Cortesi</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://dacort.dev/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://dacort.dev/posts/ title=Blog><span>Blog</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dacort.dev/>Home</a>&nbsp;»&nbsp;<a href=https://dacort.dev/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Build your own Air Quality Monitor with OpenAQ and EMR on EKS</h1><div class=post-meta><span title='2021-06-24 21:20:00 +0000 UTC'>June 24, 2021</span>&nbsp;·&nbsp;12 min</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a></li><li><a href=#pre-requisites aria-label=Pre-requisites>Pre-requisites</a></li><li><a href=#building-the-emr-on-eks-container-image aria-label="Building the EMR on EKS Container Image">Building the EMR on EKS Container Image</a><ul><li><a href=#download-the-emr-base-image aria-label="Download the EMR base image">Download the EMR base image</a></li><li><a href=#customize-the-image aria-label="Customize the image">Customize the image</a></li><li><a href=#build-and-push aria-label="Build and push">Build and push</a></li></ul></li><li><a href=#code-walkthrough aria-label="Code walkthrough">Code walkthrough</a><ul><li><a href=#reading-and-filtering-openaq-data aria-label="Reading and filtering OpenAQ Data">Reading and filtering OpenAQ Data</a></li><li><a href=#mapping-coordinates-to-counties aria-label="Mapping coordinates to counties">Mapping coordinates to counties</a></li><li><a href=#generating-our-air-quality-map aria-label="Generating our Air Quality map">Generating our Air Quality map</a></li><li><a href=#running-on-emr-on-eks aria-label="Running on EMR on EKS">Running on EMR on EKS</a></li></ul></li><li><a href=#wrapup aria-label=Wrapup>Wrapup</a></li></ul></div></details></div><div class=post-content><p>Fire season is closely approaching and as somebody that spent two weeks last year hunkered down inside with my browser glued to various air quality sites, I wanted to show how to use data from OpenAQ to build your own air quality analysis.</p><p>With Amazon EMR on EKS, you can now <a href=https://aws.amazon.com/blogs/aws/customize-and-package-dependencies-with-your-apache-spark-applications-on-amazon-emr-on-amazon-eks/>customize and package your own Apache Spark dependencies</a> and I use that functionality for this post.</p><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>OpenAQ maintains a <a href=https://registry.opendata.aws/openaq/>publicly accessible dataset of various air quality metrics</a> that&rsquo;s updated every half hour. <a href=https://docs.bokeh.org/en/latest/index.html>Bokeh</a> is a popular library for Python data visualization. While it includes sample data for US county and state boundaries, we&rsquo;re going to use <a href=https://www.census.gov/geographies/mapping-files/time-series/geo/cartographic-boundary.html>shapefiles from census.gov</a>.</p><p>We&rsquo;ll use an Apache Spark job on EMR on EKS to read the initial dataset from the S3 bucket, filter it for use case, and then combine it with the boundary data from census.gov in order to draw a map of the current air quality.</p><p>This post also shows how to use the custom containers support in EMR on EKS to build our own container image with the necessary dependencies.</p><h2 id=pre-requisites>Pre-requisites<a hidden class=anchor aria-hidden=true href=#pre-requisites>#</a></h2><ul><li>An AWS account with access to Amazon Elastic Container Registry (ECR)</li><li>An EMR on EKS cluster already setup</li><li>Docker</li><li>A container registry to push your image to</li></ul><h2 id=building-the-emr-on-eks-container-image>Building the EMR on EKS Container Image<a hidden class=anchor aria-hidden=true href=#building-the-emr-on-eks-container-image>#</a></h2><h3 id=download-the-emr-base-image>Download the EMR base image<a hidden class=anchor aria-hidden=true href=#download-the-emr-base-image>#</a></h3><p>For this post, we&rsquo;ll be using the <code>us-west-2</code> region and EMR 6.3.0 release. Each region and release has a different base image URL, and you can find the full list <a href=https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/docker-custom-images-tag.html>here</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>aws ecr get-login-password --region us-west-2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    | docker login --username AWS --password-stdin 895885662937.dkr.ecr.us-west-2.amazonaws.com
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker pull 895885662937.dkr.ecr.us-west-2.amazonaws.com/notebook-spark/emr-6.3.0:latest
</span></span></code></pre></div><h3 id=customize-the-image>Customize the image<a hidden class=anchor aria-hidden=true href=#customize-the-image>#</a></h3><p>EMR on EKS comes with a variety of <a href=https://docs.aws.amazon.com/emr/latest/ManagementGuide/emr-studio-install-libraries-and-kernels.html>default libraries</a> installed including plotly and seaborn, but we wanted to try out Bokeh for my illustration as they have a great <a href=https://docs.bokeh.org/en/latest/docs/gallery/texas.html>choropleth example</a> and it&rsquo;s a library I&rsquo;ve been hearing about occasionally. I was hoping to use Bokeh&rsquo;s <code>sampledata</code> for US and county, but I ended up using <a href=https://geopandas.org/>GeoPandas</a> to re-project my map to a conic projection so Michigan wasn&rsquo;t squashed up against Wisconsin. :) GeoPandas makes it easy to read in shapefiles, so I just used the census.gov provided state and county data.</p><p>Bokeh also uses Selenium and Chrome for it&rsquo;s static image generation, so we go ahead and install Chrome on the container image as well.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> 895885662937.dkr.ecr.us-west-2.amazonaws.com/notebook-spark/emr-6.3.0:latest</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> root</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Install Chrome</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> curl https://intoli.com/install-google-chrome.sh | bash <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    mv /usr/bin/google-chrome-stable /usr/bin/chrome<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># We need to upgrade pip in order to install pyproj</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> pip3 install --upgrade pip<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># If you pip install as root, use this</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> pip3 install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    bokeh<span style=color:#f92672>==</span>2.3.2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    boto3<span style=color:#f92672>==</span>1.17.93 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    chromedriver-py<span style=color:#f92672>==</span>91.0.4472.19.0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    geopandas<span style=color:#f92672>==</span>0.9.0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    selenium<span style=color:#f92672>==</span>3.141.0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    shapely<span style=color:#f92672>==</span>1.7.1<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> ln -s /usr/local/lib/python3.7/site-packages/chromedriver_py/chromedriver_linux64 /usr/local/bin/chromedriver<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Install bokeh sample data to /usr/local/share</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir /root/.bokeh <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    echo <span style=color:#e6db74>&#34;sampledata_dir: /usr/local/share/bokeh&#34;</span> &gt; /root/.bokeh/config <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    bokeh sampledata<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Also install census data into the image :)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> https://www2.census.gov/geo/tiger/GENZ2020/shp/cb_2020_us_state_500k.zip  /usr/local/share/bokeh/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> https://www2.census.gov/geo/tiger/GENZ2020/shp/cb_2020_us_county_500k.zip /usr/local/share/bokeh/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod <span style=color:#ae81ff>644</span> /usr/local/share/bokeh/cb*.zip<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># This is a simple test to make sure generating the image works properly</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> test /test/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> hadoop:hadoop</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=build-and-push>Build and push<a hidden class=anchor aria-hidden=true href=#build-and-push>#</a></h3><p>Great, we&rsquo;ve customized our image – now we just need to build and push it to a container registery somewhere! For this post, I chose GitHub but you can use any container registry like ECR or DockerHub.</p><p><em>The below commands assume you have a GitHub Personal Access Token that has access to push images in the <code>CR_PAT</code> environment variable.</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker build -t emr-6.3.0-bokeh:latest .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export USERNAME<span style=color:#f92672>=</span>GH_USERNAME
</span></span><span style=display:flex><span>echo $CR_PAT| docker login ghcr.io -u <span style=color:#e6db74>${</span>USERNAME<span style=color:#e6db74>}</span> --password-stdin
</span></span><span style=display:flex><span>docker tag emr-6.3.0-bokeh:latest ghcr.io/<span style=color:#e6db74>${</span>USERNAME<span style=color:#e6db74>}</span>/emr-6.3.0-bokeh:latest
</span></span><span style=display:flex><span>docker push ghcr.io/<span style=color:#e6db74>${</span>USERNAME<span style=color:#e6db74>}</span>/emr-6.3.0-bokeh:latest
</span></span></code></pre></div><p>Great, now your image is ready to go! Let&rsquo;s look at the code we&rsquo;re going to use to generate our air quality map.</p><h2 id=code-walkthrough>Code walkthrough<a hidden class=anchor aria-hidden=true href=#code-walkthrough>#</a></h2><p>If you already built your image, you can run the below code locally. In order to access S3 data, you&rsquo;ll have to set your <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_KEY_ID</code> environment variables.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --rm -it --name airq-demo <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -e AWS_ACCESS_KEY_ID <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -e AWS_SECRET_ACCESS_KEY <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    emr-6.3.0-bokeh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    pyspark --deploy-mode client --master <span style=color:#e6db74>&#39;local[1]&#39;</span>
</span></span></code></pre></div><h3 id=reading-and-filtering-openaq-data>Reading and filtering OpenAQ Data<a hidden class=anchor aria-hidden=true href=#reading-and-filtering-openaq-data>#</a></h3><p>The first thing we need to do is read the the data for today&rsquo;s date into a Spark dataframe.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>date <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>utcnow()<span style=color:#f92672>.</span>date()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> spark<span style=color:#f92672>.</span>read<span style=color:#f92672>.</span>json(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;s3://openaq-fetches/realtime-gzipped/</span><span style=color:#e6db74>{</span>date<span style=color:#e6db74>}</span><span style=color:#e6db74>/&#34;</span>)
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>show()
</span></span></code></pre></div><pre tabindex=0><code>+--------------------+---------------+---------+--------------------+-------+--------------------+--------------------+------+---------+-----------------+----------+-----+-----+
|         attribution|averagingPeriod|     city|         coordinates|country|                date|            location|mobile|parameter|       sourceName|sourceType| unit|value|
+--------------------+---------------+---------+--------------------+-------+--------------------+--------------------+------+---------+-----------------+----------+-----+-----+
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-13T22:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 25.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-13T23:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 16.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T00:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 18.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T01:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 23.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T02:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 23.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T03:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 21.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T04:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 20.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T05:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 16.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T06:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 17.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T07:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 18.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T08:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 20.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T09:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 26.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T10:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 29.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T11:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 34.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T12:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 33.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T13:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 40.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T14:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 39.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T15:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 41.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T16:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 50.0|
|[{EPA AirNow DOS,...|   {hours, 1.0}|Abu Dhabi|{24.424399, 54.43...|     AE|{2021-06-14T17:00...|US Diplomatic Pos...| false|     pm25|StateAir_AbuDhabi|government|µg/m³| 56.0|
+--------------------+---------------+---------+--------------------+-------+--------------------+--------------------+------+---------+-----------------+----------+-----+-----+
</code></pre><p>We can quickly see a few things:</p><ol><li>Data is provided from all over the globe, we just want US</li><li>We have coordinates and country, but that&rsquo;s it for location data</li><li>There are multiple different types of readings</li><li>There are multiple different readings per day per location</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>df<span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#39;unit&#39;</span>, <span style=color:#e6db74>&#39;parameter&#39;</span>)<span style=color:#f92672>.</span>distinct()<span style=color:#f92672>.</span>sort(<span style=color:#e6db74>&#34;parameter&#34;</span>)<span style=color:#f92672>.</span>show()
</span></span></code></pre></div><pre tabindex=0><code>+-----+---------+                                                               
| unit|parameter|
+-----+---------+
|µg/m³|       bc|
|µg/m³|       co|
|  ppm|       co|
|  ppm|      no2|
|µg/m³|      no2|
|µg/m³|       o3|
|  ppm|       o3|
|µg/m³|     pm10|
|µg/m³|     pm25|
|  ppm|      so2|
|µg/m³|      so2|
+-----+---------+
</code></pre><p>So, let&rsquo;s go ahead and filter down to the most recent PM2.5 reading in the United States.</p><p>To do that, it&rsquo;s a couple <code>where</code> filters and then we can utilize a window function (<code>last</code>) to get the last reading.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Filter down to US locations and PM2.5 readings only</span>
</span></span><span style=display:flex><span>usdf <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>    df<span style=color:#f92672>.</span>where(df<span style=color:#f92672>.</span>country <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;US&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>where(df<span style=color:#f92672>.</span>parameter <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pm25&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#34;coordinates&#34;</span>, <span style=color:#e6db74>&#34;date&#34;</span>, <span style=color:#e6db74>&#34;parameter&#34;</span>, <span style=color:#e6db74>&#34;unit&#34;</span>, <span style=color:#e6db74>&#34;value&#34;</span>, <span style=color:#e6db74>&#34;location&#34;</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Retrieve the most recent pm2.5 reading per county</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pyspark.sql.window <span style=color:#f92672>import</span> Window
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pyspark.sql.functions <span style=color:#f92672>import</span> last
</span></span><span style=display:flex><span>windowSpec <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>    Window<span style=color:#f92672>.</span>partitionBy(<span style=color:#e6db74>&#34;location&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>orderBy(<span style=color:#e6db74>&#34;date.utc&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>rangeBetween(Window<span style=color:#f92672>.</span>unboundedPreceding, Window<span style=color:#f92672>.</span>unboundedFollowing)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>last_reading_df <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>    usdf<span style=color:#f92672>.</span>withColumn(<span style=color:#e6db74>&#34;last_value&#34;</span>, last(<span style=color:#e6db74>&#34;value&#34;</span>)<span style=color:#f92672>.</span>over(windowSpec))
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#34;coordinates&#34;</span>, <span style=color:#e6db74>&#34;last_value&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>distinct()
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>last_reading_df<span style=color:#f92672>.</span>show()
</span></span></code></pre></div><p>We also only selected the <code>coordinates</code> and <code>last_value</code> columns as these are all we need at this point.</p><pre tabindex=0><code>+--------------------+----------+                                               
|         coordinates|last_value|
+--------------------+----------+
|{38.6619, -121.7278}|       2.0|
| {41.9767, -91.6878}|       4.9|
|{39.54092, -119.7...|       8.0|
|{43.629605, -72.3...|       9.0|
|{46.8505, -111.98...|      10.0|
|{39.818715, -75.4...|       8.5|
+--------------------+----------+
</code></pre><h3 id=mapping-coordinates-to-counties>Mapping coordinates to counties<a hidden class=anchor aria-hidden=true href=#mapping-coordinates-to-counties>#</a></h3><p>This was the most &ldquo;fun&rdquo; part of this journey. Bokeh provides some sample data and I initially just created a UDF that looked up the first county ID using the Polygon <code>intersects</code> method. Unfortunately, I then wanted to re-project the map to a conical projection (Albers). Bokeh&rsquo;s geo support isn&rsquo;t very strong, so I ended up looking at using GeoPandas to do the reprojection. That worked well, but the Bokeh county data wasn&rsquo;t in a format I could use with GeoPandas so I ended up downloading <a href=https://www.census.gov/geographies/mapping-files/time-series/geo/cartographic-boundary.html>Shapefiles from the Census Bureau</a>.</p><p>So, we&rsquo;ve got our <code>last_reading_df</code> dataframe. Lets map those coordinates to counties. The county data is relatively small (12mb zipped) so what I did was create a broadcast variable of <code>GEOID</code> -> <code>Geometry</code> mappings that could be used in a UDF to figure out if a PM2.5 reading is inside a specific county.</p><ul><li>Download the census data and create a broadcast variable</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> geopandas <span style=color:#66d9ef>as</span> gpd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COUNTY_URL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://www2.census.gov/geo/tiger/GENZ2020/shp/cb_2020_us_county_500k.zip&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>countydf <span style=color:#f92672>=</span> gpd<span style=color:#f92672>.</span>read_file(COUNTY_URL)
</span></span><span style=display:flex><span>bc_county <span style=color:#f92672>=</span> sc<span style=color:#f92672>.</span>broadcast(dict(zip(countydf[<span style=color:#e6db74>&#34;GEOID&#34;</span>], countydf[<span style=color:#e6db74>&#34;geometry&#34;</span>])))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>countydf<span style=color:#f92672>.</span>head()
</span></span></code></pre></div><p>We can see we&rsquo;re just mapping the <code>GEOID</code> column to the <code>geometry</code> column which is a polygon object containing the county boundaries.</p><pre tabindex=0><code>  STATEFP COUNTYFP  COUNTYNS        AFFGEOID  GEOID       NAME          NAMELSAD STUSPS  STATE_NAME LSAD       ALAND     AWATER                                           geometry
0      21      141  00516917  0500000US21141  21141      Logan      Logan County     KY    Kentucky   06  1430224002   12479211  POLYGON ((-87.06037 36.68085, -87.06002 36.708...
1      36      081  00974139  0500000US36081  36081     Queens     Queens County     NY    New York   06   281594050  188444349  POLYGON ((-73.96262 40.73903, -73.96243 40.739...
2      34      017  00882278  0500000US34017  34017     Hudson     Hudson County     NJ  New Jersey   06   119640822   41836491  MULTIPOLYGON (((-74.04220 40.69997, -74.03900 ...
3      34      019  00882228  0500000US34019  34019  Hunterdon  Hunterdon County     NJ  New Jersey   06  1108086284   24761598  POLYGON ((-75.19511 40.57969, -75.19466 40.581...
4      21      147  00516926  0500000US21147  21147   McCreary   McCreary County     KY    Kentucky   06  1105416696   10730402  POLYGON ((-84.77845 36.60329, -84.73068 36.665...
</code></pre><ul><li>Create a UDF to find the county a coordinate is in</li></ul><p>This just brute forces the list of GEOIDs/polygons and returns the first GEOID that intersects. There is likely a more elegant to do this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pyspark.sql.functions <span style=color:#f92672>import</span> udf
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pyspark.sql.types <span style=color:#f92672>import</span> StringType
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> shapely.geometry <span style=color:#f92672>import</span> Point
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>find_first_county_id</span>(longitude: float, latitude: float):
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> Point(longitude, latitude)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> index, geo <span style=color:#f92672>in</span> bc_county<span style=color:#f92672>.</span>value<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> geo<span style=color:#f92672>.</span>intersects(p):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> index
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>find_first_county_id_udf <span style=color:#f92672>=</span> udf(find_first_county_id, StringType())
</span></span></code></pre></div><ul><li>Now we apply to the UDF to our <code>last_reading_df</code> dataframe</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Find the county that this reading is from</span>
</span></span><span style=display:flex><span>mapped_county_df <span style=color:#f92672>=</span> last_reading_df<span style=color:#f92672>.</span>withColumn(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;GEOID&#34;</span>,
</span></span><span style=display:flex><span>    find_first_county_id_udf(
</span></span><span style=display:flex><span>        last_reading_df<span style=color:#f92672>.</span>coordinates<span style=color:#f92672>.</span>longitude, last_reading_df<span style=color:#f92672>.</span>coordinates<span style=color:#f92672>.</span>latitude
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>)<span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#34;GEOID&#34;</span>, <span style=color:#e6db74>&#34;last_value&#34;</span>)
</span></span></code></pre></div><ul><li>And then finally we calculate the average PM2.5 value per county</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Calculate the average reading per county</span>
</span></span><span style=display:flex><span>pm_avg_by_county <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>    mapped_county_df<span style=color:#f92672>.</span>groupBy(<span style=color:#e6db74>&#34;GEOID&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>agg({<span style=color:#e6db74>&#34;last_value&#34;</span>: <span style=color:#e6db74>&#34;avg&#34;</span>})
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>withColumnRenamed(<span style=color:#e6db74>&#34;avg(last_value)&#34;</span>, <span style=color:#e6db74>&#34;avg_value&#34;</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pm_avg_by_county<span style=color:#f92672>.</span>show(<span style=color:#ae81ff>5</span>)
</span></span></code></pre></div><pre tabindex=0><code>+-----+------------------+                                                      
|GEOID|         avg_value|
+-----+------------------+
|31157|              16.0|
|49053|               3.0|
|26153|               6.9|
|36029|               1.1|
|42101|             10.66|
+-----+------------------+
</code></pre><p>Cool! So now we have a <code>GEOID</code> we can use in our GeoPandas dataframe and an average value of the most recent PM2.5 reading for that county.</p><h3 id=generating-our-air-quality-map>Generating our Air Quality map<a hidden class=anchor aria-hidden=true href=#generating-our-air-quality-map>#</a></h3><p>Now that we&rsquo;ve got an average PM2.5 value per county, we need to join this with our map data and generate an image!</p><p>The first step is reading in US State and County shapefiles. We fetched these from census.gov while building the image and they&rsquo;re stored in <code>/usr/local/share/bokeh</code>. We also exclude any state not in the continental US.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> geopandas <span style=color:#66d9ef>as</span> gpd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>STATE_FILE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;file:///usr/local/share/bokeh/cb_2020_us_state_500k.zip&#34;</span>
</span></span><span style=display:flex><span>COUNTY_FILE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;file:///usr/local/share/bokeh/cb_2020_us_county_500k.zip&#34;</span>
</span></span><span style=display:flex><span>EXCLUDED_STATES <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;AK&#34;</span>, <span style=color:#e6db74>&#34;HI&#34;</span>, <span style=color:#e6db74>&#34;PR&#34;</span>, <span style=color:#e6db74>&#34;GU&#34;</span>, <span style=color:#e6db74>&#34;VI&#34;</span>, <span style=color:#e6db74>&#34;MP&#34;</span>, <span style=color:#e6db74>&#34;AS&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>county_df <span style=color:#f92672>=</span> gpd<span style=color:#f92672>.</span>read_file(COUNTY_FILE)<span style=color:#f92672>.</span>query(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;STUSPS not in </span><span style=color:#e6db74>{</span>EXCLUDED_STATES<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>state_df <span style=color:#f92672>=</span> gpd<span style=color:#f92672>.</span>read_file(STATE_FILE)<span style=color:#f92672>.</span>query(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;STUSPS not in </span><span style=color:#e6db74>{</span>EXCLUDED_STATES<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><p>Now we just do a simple <code>merge</code> on the GeoPandas dataframe, convert our maps to the Albers projection and save them as JSON objects.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Merge in our air quality data</span>
</span></span><span style=display:flex><span>county_aqi_df <span style=color:#f92672>=</span> county_df<span style=color:#f92672>.</span>merge(pm_avg_by_county<span style=color:#f92672>.</span>toPandas(), on<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;GEOID&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Convert to a &#34;proper&#34; Albers projection :)</span>
</span></span><span style=display:flex><span>state_json <span style=color:#f92672>=</span> state_df<span style=color:#f92672>.</span>to_crs(<span style=color:#e6db74>&#34;ESRI:102003&#34;</span>)<span style=color:#f92672>.</span>to_json()
</span></span><span style=display:flex><span>county_json <span style=color:#f92672>=</span> county_aqi_df<span style=color:#f92672>.</span>to_crs(<span style=color:#e6db74>&#34;ESRI:102003&#34;</span>)<span style=color:#f92672>.</span>to_json()
</span></span></code></pre></div><p>Now comes the fun part! Our data is all prepped, we&rsquo;ve averaged the most recent data by county, and built a GeoJSON file of everything we need. Let&rsquo;s map it!</p><p>I won&rsquo;t go into the details of every line, but we&rsquo;ll make use of Bokeh&rsquo;s awesome <code>GeoJSONDataSource</code> functionality, add a <code>LinearColorMapper</code> that automatically shades the counties for us by the <code>avg_value</code> column using the <code>Reds9</code> palette, and adds a <code>ColorBar</code> on the right-hand side.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> bokeh.models <span style=color:#f92672>import</span> ColorBar, GeoJSONDataSource, LinearColorMapper
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> bokeh.palettes <span style=color:#f92672>import</span> Reds9 <span style=color:#66d9ef>as</span> palette
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> bokeh.plotting <span style=color:#f92672>import</span> figure
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> figure(
</span></span><span style=display:flex><span>    title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;US Air Quality Data&#34;</span>,
</span></span><span style=display:flex><span>    plot_width<span style=color:#f92672>=</span><span style=color:#ae81ff>1100</span>,
</span></span><span style=display:flex><span>    plot_height<span style=color:#f92672>=</span><span style=color:#ae81ff>700</span>,
</span></span><span style=display:flex><span>    toolbar_location<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>    x_axis_location<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>    y_axis_location<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>    tooltips<span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#34;County&#34;</span>, <span style=color:#e6db74>&#34;@NAME&#34;</span>),
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#34;Air Quality Index&#34;</span>, <span style=color:#e6db74>&#34;@avg_value&#34;</span>),
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>grid<span style=color:#f92672>.</span>grid_line_color <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># This just adds our state lines</span>
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>patches(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;xs&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ys&#34;</span>,
</span></span><span style=display:flex><span>    fill_alpha<span style=color:#f92672>=</span><span style=color:#ae81ff>0.0</span>,
</span></span><span style=display:flex><span>    line_color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;black&#34;</span>,
</span></span><span style=display:flex><span>    line_width<span style=color:#f92672>=</span><span style=color:#ae81ff>0.5</span>,
</span></span><span style=display:flex><span>    source<span style=color:#f92672>=</span>GeoJSONDataSource(geojson<span style=color:#f92672>=</span>state_json),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Add our county data and shade them based on &#34;avg_value&#34;</span>
</span></span><span style=display:flex><span>color_mapper <span style=color:#f92672>=</span> LinearColorMapper(palette<span style=color:#f92672>=</span>tuple(reversed(palette)))
</span></span><span style=display:flex><span>color_column <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;avg_value&#34;</span>
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>patches(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;xs&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ys&#34;</span>,
</span></span><span style=display:flex><span>    fill_alpha<span style=color:#f92672>=</span><span style=color:#ae81ff>0.7</span>,
</span></span><span style=display:flex><span>    fill_color<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;field&#34;</span>: color_column, <span style=color:#e6db74>&#34;transform&#34;</span>: color_mapper},
</span></span><span style=display:flex><span>    line_color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;black&#34;</span>,
</span></span><span style=display:flex><span>    line_width<span style=color:#f92672>=</span><span style=color:#ae81ff>0.5</span>,
</span></span><span style=display:flex><span>    source<span style=color:#f92672>=</span>GeoJSONDataSource(geojson<span style=color:#f92672>=</span>county_json),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Now add a color bar legend on the right-hand side</span>
</span></span><span style=display:flex><span>color_bar <span style=color:#f92672>=</span> ColorBar(color_mapper<span style=color:#f92672>=</span>color_mapper, label_standoff<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>, width<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>add_layout(color_bar, <span style=color:#e6db74>&#34;right&#34;</span>)
</span></span></code></pre></div><p>Finally, let&rsquo;s go ahead export the png!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> bokeh.io <span style=color:#f92672>import</span> export_png
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> bokeh.io.webdriver <span style=color:#f92672>import</span> create_chromium_webdriver
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>driver <span style=color:#f92672>=</span> create_chromium_webdriver([<span style=color:#e6db74>&#34;--no-sandbox&#34;</span>])
</span></span><span style=display:flex><span>export_png(p, filename<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;map.png&#34;</span>, webdriver<span style=color:#f92672>=</span>driver)
</span></span></code></pre></div><p>Now, if you&rsquo;re running on a mac, you can just copy the generated map to your local system and open it up!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker cp airq-demo:/home/hadoop/map.png .
</span></span><span style=display:flex><span>open map.png
</span></span></code></pre></div><p><img loading=lazy src=/images/posts-airq-map.png alt="Air Quality map"></p><h3 id=running-on-emr-on-eks>Running on EMR on EKS<a hidden class=anchor aria-hidden=true href=#running-on-emr-on-eks>#</a></h3><p>I&rsquo;ve bundled this all up into a pyspark script in my <code>demo-code</code> repo.</p><p>This demo assumes you already have an EMR on EKS virtual cluster up and running, you&rsquo;ve built the image in the first part and pushed it to a container registry, and the IAM Role you use to run the job has access to both read and write to an S3 bucket.</p><p>First, download the <code>generate_aqi_map.py</code> code from the GitHub repo.</p><p>Then, upload that script to an S3 bucket you have access to.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>aws s3 cp generate_aqi_map.py s3://&lt;BUCKET&gt;/code/
</span></span></code></pre></div><p>Now, just run your job! The pyspark script takes a few parameters:</p><ul><li><code>&lt;S3_BUCKET></code> - The S3 bucket where you want to upload the generated image to</li><li><code>&lt;PREFIX></code> - The prefix in the bucket where you want the image located</li><li><code>--date 2021-01-01</code> (optional) - A specific date for which you want to generate data for<ul><li>Defaults to UTC today</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>export S3_BUCKET<span style=color:#f92672>=</span>&lt;BUCKET_NAME&gt;
</span></span><span style=display:flex><span>export EMR_EKS_CLUSTER_ID<span style=color:#f92672>=</span>abcdefghijklmno1234567890
</span></span><span style=display:flex><span>export EMR_EKS_EXECUTION_ARN<span style=color:#f92672>=</span>arn:aws:iam::123456789012:role/emr_eks_default_role
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># Replace ghcr.io/OWNER/emr-6.3.0-bokeh:latest below with your image URL</span>
</span></span><span style=display:flex><span>aws emr-containers start-job-run <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --virtual-cluster-id <span style=color:#e6db74>${</span>EMR_EKS_CLUSTER_ID<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --name openaq-conus <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --execution-role-arn <span style=color:#e6db74>${</span>EMR_EKS_EXECUTION_ARN<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --release-label emr-6.3.0-latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --job-driver <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;sparkSubmitJobDriver&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;entryPoint&#34;: &#34;s3://&#39;</span><span style=color:#e6db74>${</span>S3_BUCKET<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;/code/generate_aqi_map.py&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;entryPointArguments&#34;: [&#34;&#39;</span><span style=color:#e6db74>${</span>S3_BUCKET<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;&#34;, &#34;output/airq/&#34;],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;sparkSubmitParameters&#34;: &#34;--conf spark.kubernetes.container.image=ghcr.io/OWNER/emr-6.3.0-bokeh:latest&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --configuration-overrides <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;monitoringConfiguration&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;s3MonitoringConfiguration&#34;: { &#34;logUri&#34;: &#34;s3://&#39;</span><span style=color:#e6db74>${</span>S3_BUCKET<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;/logs/&#34; }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;0000000abcdefg12345&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;openaq-conus&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;arn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:emr-containers:us-east-2:123456789012:/virtualclusters/abcdefghijklmno1234567890/jobruns/0000000abcdefg12345&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;virtualClusterId&#34;</span>: <span style=color:#e6db74>&#34;abcdefghijklmno1234567890&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>While the job is running, you can get the fetch the status of the job using the <code>emr-containers describe-job-run</code> command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>aws emr-containers describe-job-run <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --virtual-cluster-id <span style=color:#e6db74>${</span>EMR_EKS_CLUSTER_ID<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --id 0000000abcdefg12345
</span></span></code></pre></div><p>Once the job is in the <code>COMPLETED</code> state, you should be able to copy the resulting image from your S3 bucket!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>aws s3 cp s3://<span style=color:#e6db74>${</span>S3_BUCKET<span style=color:#e6db74>}</span>/output/airq/2021-06-24-latest.png .
</span></span></code></pre></div><p>And if you open that file, you&rsquo;ll get the most recent PM2.5 readings!</p><p><img loading=lazy src=/images/posts-airq-map.png alt="Air Quality map"></p><h2 id=wrapup>Wrapup<a hidden class=anchor aria-hidden=true href=#wrapup>#</a></h2><p>Be sure to check out the <a href=https://aws.amazon.com/blogs/aws/customize-and-package-dependencies-with-your-apache-spark-applications-on-amazon-emr-on-amazon-eks/>launch post</a> for more details, the documentation for <a href=https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/docker-custom-images.html>customing docker images for EMR on EKS</a>, and my <a href=https://youtu.be/0x4DRKmNPfQ>demo video</a>.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://dacort.dev/tags/emr/>emr</a></li><li><a href=https://dacort.dev/tags/eks/>eks</a></li><li><a href=https://dacort.dev/tags/aws/>aws</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Build your own Air Quality Monitor with OpenAQ and EMR on EKS on x" href="https://x.com/intent/tweet/?text=Build%20your%20own%20Air%20Quality%20Monitor%20with%20OpenAQ%20and%20EMR%20on%20EKS&amp;url=https%3a%2f%2fdacort.dev%2fposts%2femr-eks-custom-images-with-openaq%2f&amp;hashtags=emr%2ceks%2caws"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Build your own Air Quality Monitor with OpenAQ and EMR on EKS on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fdacort.dev%2fposts%2femr-eks-custom-images-with-openaq%2f&amp;title=Build%20your%20own%20Air%20Quality%20Monitor%20with%20OpenAQ%20and%20EMR%20on%20EKS&amp;summary=Build%20your%20own%20Air%20Quality%20Monitor%20with%20OpenAQ%20and%20EMR%20on%20EKS&amp;source=https%3a%2f%2fdacort.dev%2fposts%2femr-eks-custom-images-with-openaq%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Build your own Air Quality Monitor with OpenAQ and EMR on EKS on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fdacort.dev%2fposts%2femr-eks-custom-images-with-openaq%2f&title=Build%20your%20own%20Air%20Quality%20Monitor%20with%20OpenAQ%20and%20EMR%20on%20EKS"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Build your own Air Quality Monitor with OpenAQ and EMR on EKS on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fdacort.dev%2fposts%2femr-eks-custom-images-with-openaq%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Build your own Air Quality Monitor with OpenAQ and EMR on EKS on whatsapp" href="https://api.whatsapp.com/send?text=Build%20your%20own%20Air%20Quality%20Monitor%20with%20OpenAQ%20and%20EMR%20on%20EKS%20-%20https%3a%2f%2fdacort.dev%2fposts%2femr-eks-custom-images-with-openaq%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Build your own Air Quality Monitor with OpenAQ and EMR on EKS on telegram" href="https://telegram.me/share/url?text=Build%20your%20own%20Air%20Quality%20Monitor%20with%20OpenAQ%20and%20EMR%20on%20EKS&amp;url=https%3a%2f%2fdacort.dev%2fposts%2femr-eks-custom-images-with-openaq%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Build your own Air Quality Monitor with OpenAQ and EMR on EKS on ycombinator" href="https://news.ycombinator.com/submitlink?t=Build%20your%20own%20Air%20Quality%20Monitor%20with%20OpenAQ%20and%20EMR%20on%20EKS&u=https%3a%2f%2fdacort.dev%2fposts%2femr-eks-custom-images-with-openaq%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://dacort.dev/>Damon Cortesi</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>